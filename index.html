<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milimar JAGC | Oficina Virtual</title>
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo Aurora OSCURO */
        body {
            background: linear-gradient(125deg, #0a0f1a 0%, #0f2a3a 35%, #1a3f3a 70%, #4a3a1a 100%);
            background-size: 400% 400%;
            animation: aurora 15s ease infinite;
            font-family: 'Inter', sans-serif;
        }
        @keyframes aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        h1, h2, h3, .font-display {
            font-family: 'Poppins', sans-serif;
            font-weight: 900;
            letter-spacing: -0.02em;
        }
        .glass-card {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        .node {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            transition: 0.3s;
            margin: 0 4px;
            font-family: 'Poppins', sans-serif;
        }
        .node-filled {
            background: linear-gradient(145deg, #fbbf24, #f59e0b);
            color: black;
            border: 2px solid white;
            box-shadow: 0 0 20px #fbbf24;
        }
        .node-empty {
            border: 2px dashed rgba(255, 215, 0, 0.3);
            color: rgba(255, 255, 255, 0.5);
            background: transparent;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            transition: opacity 0.3s;
            max-width: 300px;
        }
        .btn {
            @apply font-black py-3 px-6 rounded-xl transition-all transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed;
            font-family: 'Poppins', sans-serif;
        }
        .tutorial-step, .benefit-step, .feed-item {
            @apply bg-white/10 p-3 rounded-lg mb-2 text-sm border border-white/20;
        }
        .telegram-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 50;
            background: linear-gradient(145deg, #2AABEE, #229ED9);
            padding: 12px 24px;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(42, 171, 238, 0.5);
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
            border: 1px solid rgba(255,255,255,0.3);
            text-decoration: none;
        }
        .telegram-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(42, 171, 238, 0.7);
        }
        .tab-button {
            @apply px-6 py-3 rounded-t-xl font-bold transition-all;
        }
        .tab-active {
            @apply bg-yellow-500 text-black;
        }
        .tab-inactive {
            @apply bg-white/10 text-white hover:bg-white/20;
        }
        .feed-container {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="text-white antialiased p-4 min-h-screen relative">

    <!-- Bot√≥n flotante de Telegram -->
    <a id="telegramLink" href="https://t.me/+z7wwfx0ocho1NzI5" target="_blank" class="telegram-button hidden">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.02-.15-.05-.22-.07-.07-.18-.05-.26-.03-.11.02-1.85 1.17-5.22 3.45-.5.34-.95.5-1.36.49-.45-.01-1.3-.25-1.94-.46-.78-.26-1.4-.4-1.35-.85.03-.23.27-.47.74-.72 2.91-1.27 4.86-2.11 5.83-2.52 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.08-.02.25-.04.4z"/></svg>
        <span>Grupo Oficial Milimar</span>
    </a>

    <div id="toast" class="toast glass-card p-4 hidden">
        <p id="toastMsg" class="text-sm"></p>
    </div>

    <div class="max-w-3xl mx-auto">
        <header class="text-center py-8">
            <div class="flex items-center justify-center gap-4">
                <h1 class="text-6xl font-black text-white drop-shadow-2xl tracking-tighter" style="text-shadow: 0 0 20px rgba(251,191,36,0.5);">MILIMAR JAGC</h1>
            </div>
            <p class="text-sm text-white/80 uppercase tracking-[0.3em] font-light mt-2">Oficina Virtual ¬∑ BSC</p>
        </header>

        <!-- Pesta√±as de navegaci√≥n -->
        <div class="flex justify-center gap-2 mb-6">
            <button id="btnMembresia" class="tab-button tab-active">MEMBRES√çA</button>
            <button id="btnArbitraje" class="tab-button tab-inactive">ARBITRAJE (pr√≥ximamente)</button>
        </div>

        <!-- Contenedor principal (se conectar√° despu√©s de conectar wallet) -->
        <div id="conBox" class="glass-card p-10 text-center mb-6">
            <button id="btnConnect" class="btn bg-white text-black w-full max-w-md mx-auto hover:bg-yellow-300 transition">CONECTAR BILLETERA</button>
        </div>

        <!-- SECCI√ìN MEMBRES√çA (visible por defecto) -->
        <div id="seccionMembresia" class="space-y-6">
            <!-- Tarjetas de resumen (4) -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="glass-card p-4 border-l-4 border-green-400">
                    <p class="text-[10px] text-white/60 uppercase font-bold">Saldo Pendiente</p>
                    <p id="valSaldo" class="text-xl font-black text-green-300">0.00</p>
                </div>
                <div class="glass-card p-4 border-r-4 border-yellow-400 text-right">
                    <p class="text-[10px] text-white/60 uppercase font-bold">Red Total</p>
                    <p id="valRed" class="text-xl font-black text-yellow-300">0</p>
                </div>
                <div class="glass-card p-4 border-l-4 border-blue-400">
                    <p class="text-[10px] text-white/60 uppercase font-bold">Directos</p>
                    <p id="valDir" class="text-xl font-black text-blue-300">0</p>
                </div>
                <div class="glass-card p-4 border-r-4 border-purple-400 text-right">
                    <p class="text-[10px] text-white/60 uppercase font-bold">D√≠as activo</p>
                    <p id="valDias" class="text-xl font-black text-purple-300">0</p>
                </div>
            </div>

            <!-- Fondos: Solidaridad, Pool Liderazgo, Emergencia -->
            <div class="grid grid-cols-3 gap-3">
                <div class="glass-card p-3 text-center">
                    <p class="text-[10px] text-white/60 uppercase font-bold">Fondo Solidaridad</p>
                    <p id="fondoSolidaridad" class="text-lg font-black text-emerald-300">0.00</p>
                </div>
                <div class="glass-card p-3 text-center">
                    <p class="text-[10px] text-white/60 uppercase font-bold">Pool Liderazgo</p>
                    <p id="poolLiderazgo" class="text-lg font-black text-yellow-300">0.00</p>
                </div>
                <div class="glass-card p-3 text-center" id="emergencyContainer">
                    <p class="text-[10px] text-white/60 uppercase font-bold">Modo Emergencia</p>
                    <p id="emergencyStatus" class="text-lg font-black text-red-300">INACTIVO</p>
                </div>
            </div>

            <!-- Bot√≥n de retiro de emergencia -->
            <button id="btnEmergencyWithdraw" class="hidden w-full bg-red-700 text-white font-bold py-3 rounded-xl hover:bg-red-600 transition">üö® RETIRO DE EMERGENCIA</button>

            <!-- Visualizaci√≥n de 5 niveles -->
            <div class="glass-card p-6 text-center">
                <p class="text-white text-sm font-bold mb-4 drop-shadow">üìä TUS 5 NIVELES DE RED</p>
                <div class="flex flex-wrap justify-center gap-2">
                    <div id="n1" class="node node-empty">N1<br><span class="text-[10px]">0</span></div>
                    <div id="n2" class="node node-empty">N2<br><span class="text-[10px]">0</span></div>
                    <div id="n3" class="node node-empty">N3<br><span class="text-[10px]">0</span></div>
                    <div id="n4" class="node node-empty">N4<br><span class="text-[10px]">0</span></div>
                    <div id="n5" class="node node-empty">N5<br><span class="text-[10px]">0</span></div>
                </div>
                <p class="text-[10px] text-white/50 mt-4">Cada c√≠rculo muestra la cantidad de personas en ese nivel.</p>
            </div>

            <!-- Detalles por nivel y ganancias -->
            <div class="grid md:grid-cols-2 gap-4">
                <div class="glass-card p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-white font-bold text-sm drop-shadow">üìä SOCIOS POR NIVEL</h3>
                        <button id="btnReloadDetails" class="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition">‚ü≥ Recargar</button>
                    </div>
                    <div id="redNiveles" class="space-y-1 text-xs"><p class="text-white/50">Cargando...</p></div>
                </div>
                <div class="glass-card p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-white font-bold text-sm drop-shadow">üí∞ GANANCIAS ACUMULADAS</h3>
                        <button id="btnReloadGanancias" class="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition">‚ü≥ Recargar</button>
                    </div>
                    <div id="gananciasNiveles" class="space-y-1 text-xs"><p class="text-white/50">Cargando...</p></div>
                </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="grid grid-cols-2 gap-3">
                <button id="btnApprove" class="btn bg-blue-600 text-white hover:bg-blue-500">1. AUTORIZAR USDT</button>
                <button id="btnJoin" class="btn bg-yellow-500 text-black hover:bg-yellow-400">2. ACTIVAR (10 USDT)</button>
                <button id="btnRenew" class="btn bg-indigo-600 text-white hover:bg-indigo-500">RENOVAR</button>
                <button id="btnWithdraw" class="btn bg-green-600 text-white hover:bg-green-500">RETIRAR</button>
            </div>

            <!-- Panel Admin -->
            <div id="adminSection" class="hidden glass-card p-4 border border-yellow-500/50">
                <h2 class="text-white font-bold mb-3 text-sm uppercase tracking-wider drop-shadow">‚öôÔ∏è Panel Admin</h2>
                <div class="grid grid-cols-2 gap-2">
                    <button id="btnPausa" class="btn bg-red-600 text-white text-sm py-2 hover:bg-red-500">PAUSAR/REANUDAR</button>
                    <button id="btnCupos" class="btn bg-purple-600 text-white text-sm py-2 hover:bg-purple-500">OTORGAR CUPOS</button>
                    <button id="btnPremiar" class="btn bg-pink-600 text-white text-sm py-2 hover:bg-pink-500">PREMIAR L√çDER</button>
                    <button id="btnRecuperar" class="btn bg-orange-600 text-white text-sm py-2 hover:bg-orange-500">RECUPERAR TOKEN</button>
                </div>
                <div class="mt-2 text-[10px] text-white/50">Usa estas funciones con responsabilidad.</div>
            </div>

            <!-- Secci√≥n de comunidad -->
            <div class="glass-card p-4 text-center">
                <h3 class="text-white font-bold mb-2 text-sm drop-shadow">üì¢ COMUNIDAD OFICIAL</h3>
                <p class="text-xs text-white/70 mb-3">Accede a nuestro grupo privado de Telegram para soporte, novedades y conectar con otros l√≠deres.</p>
                <a href="https://t.me/+z7wwfx0ocho1NzI5" target="_blank" class="inline-block bg-[#2AABEE] text-white font-bold py-3 px-6 rounded-full hover:scale-105 transition shadow-lg hover:shadow-[#2AABEE]/50">
                    <span class="flex items-center gap-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.02-.15-.05-.22-.07-.07-.18-.05-.26-.03-.11.02-1.85 1.17-5.22 3.45-.5.34-.95.5-1.36.49-.45-.01-1.3-.25-1.94-.46-.78-.26-1.4-.4-1.35-.85.03-.23.27-.47.74-.72 2.91-1.27 4.86-2.11 5.83-2.52 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.08-.02.25-.04.4z"/></svg>
                        Ir al Grupo Oficial
                    </span>
                </a>
            </div>

            <!-- Enlace de invitaci√≥n -->
            <div class="glass-card p-4 text-center">
                <p class="text-[10px] text-white/50 mb-1 uppercase font-bold">TU ENLACE DE INVITACI√ìN</p>
                <div class="flex items-center gap-2">
                    <input id="refLink" readonly class="w-full bg-white/10 border border-white/30 rounded-lg p-2 text-center text-white text-xs outline-none">
                    <button id="copyLinkBtn" class="bg-white text-black font-bold py-2 px-4 rounded-lg text-sm hover:bg-yellow-300 transition">Copiar</button>
                </div>
                <p id="copyMsg" class="text-[10px] text-green-300 mt-2 hidden">¬°Link copiado!</p>
            </div>

            <!-- Tutoriales -->
            <div class="glass-card p-4">
                <details class="cursor-pointer">
                    <summary class="text-white font-bold text-sm list-none flex justify-between items-center drop-shadow">
                        üìò TUTORIALES R√ÅPIDOS
                        <span class="text-xs text-white/60">(clic para expandir)</span>
                    </summary>
                    <div class="mt-4 space-y-3">
                        <div class="tutorial-step">
                            <p class="font-bold text-yellow-300">üîπ Autorizar USDT</p>
                            <p class="text-xs text-white/80">1. Aseg√∫rate de tener USDT en tu wallet.<br>2. Haz clic en "AUTORIZAR USDT".<br>3. Confirma la transacci√≥n (solo gas).</p>
                        </div>
                        <div class="tutorial-step">
                            <p class="font-bold text-yellow-300">üîπ Activar suscripci√≥n</p>
                            <p class="text-xs text-white/80">1. Despu√©s de autorizar, haz clic en "ACTIVAR".<br>2. Ingresa la direcci√≥n de tu patrocinador (si no viene por link).<br>3. Confirma la transacci√≥n (10 USDT + gas).</p>
                        </div>
                        <div class="tutorial-step">
                            <p class="font-bold text-yellow-300">üîπ Renovar</p>
                            <p class="text-xs text-white/80">Paga 10 USDT para extender tu membres√≠a 30 d√≠as m√°s.</p>
                        </div>
                        <div class="tutorial-step">
                            <p class="font-bold text-yellow-300">üîπ Retirar ganancias</p>
                            <p class="text-xs text-white/80">Solo cuando tengas al menos 4 directos y saldo ‚â•10 USDT.</p>
                        </div>
                        <div class="tutorial-step">
                            <p class="font-bold text-yellow-300">üîπ Invitar</p>
                            <p class="text-xs text-white/80">Comparte tu link de invitaci√≥n. Cuando alguien se registre con √©l, ser√° tu referido directo.</p>
                        </div>
                    </div>
                </details>
            </div>

            <!-- FEED DE ACTIVIDAD P√öBLICA (transparencia) -->
            <div class="glass-card p-4">
                <h3 class="text-white font-bold text-sm mb-2 drop-shadow">üì¢ ACTIVIDAD RECIENTE DE LA COMUNIDAD</h3>
                <div id="feedActividad" class="feed-container space-y-2 pr-2">
                    <p class="text-white/50 text-xs">Conecta tu wallet para ver la actividad en tiempo real...</p>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN ARBITRAJE (oculta inicialmente) -->
        <div id="seccionArbitraje" class="hidden space-y-6">
            <div class="glass-card p-6 text-center">
                <h2 class="text-2xl font-bold text-yellow-400 mb-4">FONDO DE ARBITRAJE DEFI</h2>
                <p class="text-sm text-white/70 mb-6">Pr√≥ximamente: Invierte en nuestro fondo automatizado de arbitraje entre exchanges descentralizados. Genera rendimientos mientras contribuyes a la liquidez del ecosistema.</p>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="glass-card p-3">
                        <p class="text-[10px] text-white/50">Total en fondo</p>
                        <p class="text-xl font-black text-green-300">-- USDT</p>
                    </div>
                    <div class="glass-card p-3">
                        <p class="text-[10px] text-white/50">Mi inversi√≥n</p>
                        <p class="text-xl font-black text-blue-300">-- USDT</p>
                    </div>
                    <div class="glass-card p-3">
                        <p class="text-[10px] text-white/50">Ganancias</p>
                        <p class="text-xl font-black text-yellow-300">-- USDT</p>
                    </div>
                    <div class="glass-card p-3">
                        <p class="text-[10px] text-white/50">APY estimado</p>
                        <p class="text-xl font-black text-purple-300">-- %</p>
                    </div>
                </div>

                <div class="bg-yellow-500/20 border border-yellow-500 rounded-lg p-4 mb-6">
                    <p class="text-yellow-300 font-bold">üöß EN DESARROLLO</p>
                    <p class="text-xs text-white/70 mt-2">Estamos trabajando en un contrato inteligente independiente para arbitraje. Mientras tanto, puedes unirte a nuestro grupo de Telegram para recibir noticias sobre su lanzamiento.</p>
                </div>

                <div class="flex gap-3">
                    <button class="btn bg-gray-600 text-white opacity-50 cursor-not-allowed flex-1">DEPOSITAR</button>
                    <button class="btn bg-gray-600 text-white opacity-50 cursor-not-allowed flex-1">RETIRAR</button>
                </div>
                <p class="text-[10px] text-white/30 mt-2">Funciones disponibles pr√≥ximamente</p>
            </div>

            <!-- Explicaci√≥n del arbitraje -->
            <div class="glass-card p-4">
                <details class="cursor-pointer">
                    <summary class="text-white font-bold text-sm list-none flex justify-between items-center drop-shadow">
                        üìò ¬øC√ìMO FUNCIONAR√Å EL ARBITRAJE?
                        <span class="text-xs text-white/60">clic para expandir</span>
                    </summary>
                    <div class="mt-4 space-y-2 text-xs text-white/80">
                        <p>üîπ <span class="text-yellow-300">Fondo colectivo:</span> Los usuarios depositan USDT en un contrato independiente.</p>
                        <p>üîπ <span class="text-yellow-300">Bot automatizado:</span> Un algoritmo detecta diferencias de precio entre DEXs (PancakeSwap, Biswap, etc.) y ejecuta operaciones.</p>
                        <p>üîπ <span class="text-yellow-300">Ganancias distribuidas:</span> Las utilidades se reparten proporcionalmente entre los participantes.</p>
                        <p>üîπ <span class="text-yellow-300">Seguridad:</span> El contrato de arbitraje es independiente del de membres√≠a, protegiendo tus fondos.</p>
                        <p class="mt-2 text-white/50">‚è±Ô∏è Tiempo estimado de desarrollo: 2-4 meses.</p>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <script>
        // üü¢ CONFIGURACI√ìN (ACTUALIZA CON TU NUEVA DIRECCI√ìN)
        const CONTRACT_ADDR = "0x497D328d5d59E191Eb7FC411a876CefB8B43176c"; // Milimar_v4
        const USDT_ADDR = "0x55d398326f99059fF775485246999027B3197955";
        const BSC_CHAIN_ID = 56;
        const TELEGRAM_GRUPO = "https://t.me/+z7wwfx0ocho1NzI5";

        // ABI del contrato (versi√≥n simplificada para evitar stack too deep)
        const abi = [
            "function consultarEstado(address) view returns (uint256,uint256,uint256,uint256,uint256,uint256,bool)",
            "function unirse(address)",
            "function renovarSuscripcion()",
            "function retirarGanancias()",
            "function verDetalleRed(address) view returns (uint256[5] memory)",
            "function verDetalleGanancias(address) view returns (uint256[5] memory)",
            "function admin() view returns (address)",
            "function togglePausa()",
            "function otorgarCuposExtra(address,uint256)",
            "function premiarLider(address,uint256)",
            "function recuperarTokenExterno(address,uint256)",
            "function fondoSolidaridad() view returns (uint256)",
            "function poolLiderazgo() view returns (uint256)",
            "function emergencyMode() view returns (bool)",
            "function emergencyWithdraw()",
            "event RegistroGlobal(address indexed usuario, address indexed patrocinador, uint256 fecha)",
            "event BonoNivel3Alcanzado(address indexed usuario, uint256 fecha)",
            "event RetiroExitoso(address indexed usuario, uint256 monto)",
            "event PremiadoLider(address indexed lider, uint256 monto)",
            "event FondoSolidaridadUsado(address beneficiado, uint256 monto, string motivo)"
        ];
        const usdtAbi = ["function approve(address spender, uint256 amount) returns (bool)"];

        // Estado
        let provider, signer, userAddress, contract, usdtContract;
        let isAdmin = false;
        let toastTimeout;

        // Elementos DOM
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMsg');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const refLink = document.getElementById('refLink');
        const copyMsg = document.getElementById('copyMsg');
        const telegramLink = document.getElementById('telegramLink');
        const fondoElem = document.getElementById('fondoSolidaridad');
        const poolElem = document.getElementById('poolLiderazgo');
        const emergencyStatus = document.getElementById('emergencyStatus');
        const emergencyContainer = document.getElementById('emergencyContainer');
        const btnEmergency = document.getElementById('btnEmergencyWithdraw');
        const feedActividad = document.getElementById('feedActividad');
        const btnMembresia = document.getElementById('btnMembresia');
        const btnArbitraje = document.getElementById('btnArbitraje');
        const seccionMembresia = document.getElementById('seccionMembresia');
        const seccionArbitraje = document.getElementById('seccionArbitraje');

        // Inicializar pesta√±as
        btnMembresia.addEventListener('click', () => {
            btnMembresia.classList.add('tab-active');
            btnMembresia.classList.remove('tab-inactive');
            btnArbitraje.classList.add('tab-inactive');
            btnArbitraje.classList.remove('tab-active');
            seccionMembresia.classList.remove('hidden');
            seccionArbitraje.classList.add('hidden');
        });

        btnArbitraje.addEventListener('click', () => {
            btnArbitraje.classList.add('tab-active');
            btnArbitraje.classList.remove('tab-inactive');
            btnMembresia.classList.add('tab-inactive');
            btnMembresia.classList.remove('tab-active');
            seccionMembresia.classList.add('hidden');
            seccionArbitraje.classList.remove('hidden');
        });

        // Funci√≥n para agregar al feed de actividad
        function agregarAlFeed(mensaje, tipo = 'info') {
            const item = document.createElement('div');
            item.className = `feed-item border-l-4 ${tipo === 'premio' ? 'border-yellow-500' : tipo === 'registro' ? 'border-green-500' : 'border-blue-500'}`;
            item.innerHTML = `<p class="text-xs text-white/80">${mensaje}</p>`;
            feedActividad.prepend(item); // Los m√°s nuevos arriba
            if (feedActividad.children.length > 20) {
                feedActividad.removeChild(feedActividad.lastChild);
            }
        }

        function showToast(msg, isError = false) {
            clearTimeout(toastTimeout);
            toast.classList.remove('hidden');
            toastMsg.innerText = msg;
            toast.style.backgroundColor = isError ? 'rgba(127,29,29,0.9)' : 'rgba(6,78,59,0.9)';
            toastTimeout = setTimeout(() => toast.classList.add('hidden'), 4000);
        }

        copyLinkBtn.addEventListener('click', () => {
            refLink.select();
            refLink.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(refLink.value).then(() => {
                copyMsg.classList.remove('hidden');
                setTimeout(() => copyMsg.classList.add('hidden'), 2000);
            }).catch(() => showToast('Error al copiar', true));
        });

        async function checkNetwork() {
            const network = await provider.getNetwork();
            if (network.chainId !== BSC_CHAIN_ID) {
                try {
                    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x38' }] });
                } catch {
                    showToast('Cambia a BSC Mainnet en tu wallet', true);
                    return false;
                }
            }
            return true;
        }

        async function loadRedYGanancias(intentos = 3) {
            for (let i = 0; i < intentos; i++) {
                try {
                    const red = await contract.verDetalleRed(userAddress);
                    const ganancias = await contract.verDetalleGanancias(userAddress);
                    for (let j = 0; j < 5; j++) {
                        const node = document.getElementById('n' + (j+1));
                        const cantidad = red[j].toNumber();
                        node.innerHTML = `N${j+1}<br><span class="text-[10px]">${cantidad}</span>`;
                        if (cantidad > 0) {
                            node.classList.add('node-filled');
                            node.classList.remove('node-empty');
                        } else {
                            node.classList.add('node-empty');
                            node.classList.remove('node-filled');
                        }
                    }
                    let redHtml = '', ganHtml = '';
                    for (let j = 0; j < 5; j++) {
                        redHtml += `<div class="flex justify-between"><span>Nivel ${j+1}:</span><span class="font-bold">${red[j].toString()}</span></div>`;
                        ganHtml += `<div class="flex justify-between"><span>Nivel ${j+1}:</span><span class="font-bold">${ethers.utils.formatUnits(ganancias[j], 18)} USDT</span></div>`;
                    }
                    document.getElementById('redNiveles').innerHTML = redHtml;
                    document.getElementById('gananciasNiveles').innerHTML = ganHtml;
                    return;
                } catch (e) {
                    if (i === intentos - 1) {
                        document.getElementById('redNiveles').innerHTML = '<p class="text-red-400">Error al cargar. Intenta recargar manualmente.</p>';
                        document.getElementById('gananciasNiveles').innerHTML = '<p class="text-red-400">Error al cargar.</p>';
                        showToast('No se pudieron cargar los detalles de la red', true);
                    } else await new Promise(r => setTimeout(r, 1000));
                }
            }
        }

        async function loadUserData() {
            try {
                const data = await contract.consultarEstado(userAddress);
                document.getElementById('valSaldo').innerText = ethers.utils.formatUnits(data[0], 18);
                document.getElementById('valDir').innerText = data[3].toString();
                document.getElementById('valRed').innerText = data[4].toString();
                document.getElementById('valDias').innerText = data[5].toString();
                await loadRedYGanancias();

                const fondo = await contract.fondoSolidaridad();
                fondoElem.innerText = ethers.utils.formatUnits(fondo, 18) + ' USDT';
                const pool = await contract.poolLiderazgo();
                poolElem.innerText = ethers.utils.formatUnits(pool, 18) + ' USDT';
                const emergency = await contract.emergencyMode();
                emergencyStatus.innerText = emergency ? 'ACTIVO' : 'INACTIVO';
                if (emergency) {
                    emergencyContainer.classList.add('border-2', 'border-red-500');
                    btnEmergency.classList.remove('hidden');
                } else {
                    emergencyContainer.classList.remove('border-2', 'border-red-500');
                    btnEmergency.classList.add('hidden');
                }
            } catch (e) {
                console.error('Error en loadUserData:', e);
                showToast('Error al cargar datos b√°sicos', true);
            }
        }

        async function connect() {
            if (!window.ethereum) return showToast('Instala MetaMask/OKX Wallet', true);
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                if (!await checkNetwork()) return;

                contract = new ethers.Contract(CONTRACT_ADDR, abi, signer);
                usdtContract = new ethers.Contract(USDT_ADDR, usdtAbi, signer);

                document.getElementById('conBox').classList.add('hidden');
                seccionMembresia.classList.remove('hidden');
                telegramLink.classList.remove('hidden');
                refLink.value = window.location.origin + window.location.pathname + "?ref=" + userAddress;

                const adminAddr = await contract.admin();
                isAdmin = (adminAddr.toLowerCase() === userAddress.toLowerCase());
                if (isAdmin) document.getElementById('adminSection').classList.remove('hidden');

                await loadUserData();

                // Escuchar eventos para el feed de actividad
                contract.on("RegistroGlobal", (usuario, patrocinador, fecha) => {
                    agregarAlFeed(`üéâ Nuevo registro: ${usuario.slice(0,6)}...${usuario.slice(-4)}`, 'registro');
                });
                contract.on("BonoNivel3Alcanzado", (usuario, fecha) => {
                    agregarAlFeed(`üèÜ Bono nivel 3 alcanzado por ${usuario.slice(0,6)}...${usuario.slice(-4)}`, 'premio');
                });
                contract.on("RetiroExitoso", (usuario, monto) => {
                    agregarAlFeed(`üí∞ Retiro de ${ethers.utils.formatUnits(monto,18)} USDT por ${usuario.slice(0,6)}...${usuario.slice(-4)}`, 'info');
                });
                contract.on("PremiadoLider", (lider, monto) => {
                    agregarAlFeed(`üèÖ Premio a l√≠der ${lider.slice(0,6)}...${lider.slice(-4)}: ${ethers.utils.formatUnits(monto,18)} USDT`, 'premio');
                });
                contract.on("FondoSolidaridadUsado", (beneficiario, monto, motivo) => {
                    agregarAlFeed(`ü§ù Apoyo solidario a ${beneficiario.slice(0,6)}...${beneficiario.slice(-4)}: ${ethers.utils.formatUnits(monto,18)} USDT (${motivo})`, 'info');
                });

                // Cargar √∫ltimos eventos (opcional)
                // Podr√≠as usar getLogs aqu√≠ para historial
            } catch (e) {
                showToast('Error conectando: ' + e.message, true);
            }
        }

        document.getElementById('btnConnect').onclick = connect;

        document.getElementById('btnApprove').onclick = async () => {
            try {
                const tx = await usdtContract.approve(CONTRACT_ADDR, ethers.utils.parseUnits("100", 18));
                showToast('Autorizando...');
                await tx.wait();
                showToast('‚úÖ USDT autorizado');
            } catch (e) { showToast('Error: ' + e.message, true); }
        };

        document.getElementById('btnJoin').onclick = async () => {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                let sponsor = urlParams.get('ref');
                if (!sponsor || sponsor === userAddress) {
                    sponsor = prompt('Direcci√≥n del patrocinador:');
                    if (!sponsor) return;
                }
                const tx = await contract.unirse(sponsor);
                showToast('Activando...');
                await tx.wait();
                showToast('‚úÖ Registro exitoso');
                await loadUserData();
            } catch (e) { showToast('Error: ' + e.message, true); }
        };

        document.getElementById('btnRenew').onclick = async () => {
            try {
                const tx = await contract.renovarSuscripcion();
                showToast('Renovando...');
                await tx.wait();
                showToast('‚úÖ Suscripci√≥n renovada');
                await loadUserData();
            } catch (e) { showToast('Error: ' + e.message, true); }
        };

        document.getElementById('btnWithdraw').onclick = async () => {
            try {
                const tx = await contract.retirarGanancias();
                showToast('Retirando...');
                await tx.wait();
                showToast('‚úÖ Retiro exitoso');
                await loadUserData();
            } catch (e) { showToast('Error: ' + e.message, true); }
        };

        document.getElementById('btnReloadDetails').onclick = loadRedYGanancias;
        document.getElementById('btnReloadGanancias').onclick = loadRedYGanancias;

        // Admin functions
        document.getElementById('btnPausa').onclick = async () => {
            if (!isAdmin || !confirm('¬øCambiar estado de pausa?')) return;
            try { await (await contract.togglePausa()).wait(); showToast('‚úÖ Pausa cambiada'); } catch (e) { showToast('Error: ' + e.message, true); }
        };
        document.getElementById('btnCupos').onclick = async () => {
            if (!isAdmin) return;
            const lider = prompt('Direcci√≥n del l√≠der:'); const cant = prompt('Cantidad de cupos:');
            if (!lider || !cant) return;
            try { await (await contract.otorgarCuposExtra(lider, cant)).wait(); showToast('‚úÖ Cupos otorgados'); } catch (e) { showToast('Error: ' + e.message, true); }
        };
        document.getElementById('btnPremiar').onclick = async () => {
            if (!isAdmin) return;
            const lider = prompt('Direcci√≥n del l√≠der:'); const monto = prompt('Monto en USDT:');
            if (!lider || !monto) return;
            try { await (await contract.premiarLider(lider, ethers.utils.parseUnits(monto, 18))).wait(); showToast('‚úÖ Premio enviado'); } catch (e) { showToast('Error: ' + e.message, true); }
        };
        document.getElementById('btnRecuperar').onclick = async () => {
            if (!isAdmin) return;
            const token = prompt('Direcci√≥n del token (no USDT):'); const cant = prompt('Cantidad:');
            if (!token || !cant) return;
            try { await (await contract.recuperarTokenExterno(token, ethers.utils.parseUnits(cant, 18))).wait(); showToast('‚úÖ Tokens recuperados'); } catch (e) { showToast('Error: ' + e.message, true); }
        };

        btnEmergency.onclick = async () => {
            if (!confirm('¬øEst√°s seguro de retirar todos tus fondos en modo de emergencia?')) return;
            try {
                const tx = await contract.emergencyWithdraw();
                showToast('Procesando retiro de emergencia...');
                await tx.wait();
                showToast('‚úÖ Retiro de emergencia completado');
                await loadUserData();
            } catch (e) { showToast('Error: ' + e.message, true); }
        };

        window.addEventListener('load', () => {
            if (window.ethereum && window.ethereum.selectedAddress) connect();
        });
    </script>
    <footer class="text-center text-[10px] text-gray-500 mt-4">Milimar Protocol ¬∑ BSC ¬∑ Contrato: 0x497D...3176C</footer>
</body>
                            </html>
